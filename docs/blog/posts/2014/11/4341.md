---
creators:
  - Gabriel Cánepa
  - GOLinux
title: 系统之锹sysdig：Linux服务器监控和排障利器
date: 2014-11-30 21:31:09
date_updated: 2014-11-30 21:31:09
slug: article-4341-1.html
url: https://linux.cn/article-4341-1.html
url_from: http://xmodulo.com/monitor-troubleshoot-linux-server-sysdig.html
image: album/201411/30/212928sfllnunlu88kpueo.png
tags:
  - lsof
  - strace
  - sysdig
  - tcpdump
  - 监控
categories:
  - 系统运维
---

## Summary

> 当你需要追踪某个进程产生和接收的系统调用时，首先浮现在你脑海中的是什么？你可能会想到strace，那么你是对的。你会使用什么样的命令行工具来监控原始网络通信呢？如果你想到了tcpdump，你又作出了一个极佳的选择。而如果你碰到必须追踪打开的文件（在Unix意义上：一切皆文件）的需求，可能你会使用lsof。 strace、tcpdump以及lsof，确实是些伟大的工具，它们应该成为每个系统管理员工具集之中的一部分，而这也正是你为什么应该爱上sysdig的原因。它是一个强大的开源工具，用于系统级别的勘察和排障，它的创建者在介绍它时称之为strace+

***

<!-- more -->

## Contents

当你需要追踪某个进程产生和接收的系统调用时，首先浮现在你脑海中的是什么？你可能会想到strace，那么你是对的。你会使用什么样的命令行工具来监控原始网络通信呢？如果你想到了tcpdump，你又作出了一个极佳的选择。而如果你碰到必须追踪打开的文件（在Unix意义上：一切皆文件）的需求，可能你会使用lsof。

strace、tcpdump以及lsof，确实是些伟大的工具，它们应该成为每个系统管理员工具集之中的一部分，而这也正是你为什么应该爱上[sysdig](http://www.sysdig.org/)的原因。它是一个强大的开源工具，用于系统级别的勘察和排障，它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”。抛开幽默不说，sysdig的最棒特性之一在于，它不仅能分析Linux系统的“现场”状态，也能将该状态保存为转储文件以供离线检查。更重要的是，你可以自定义sysdig的行为，或者甚至通过内建的（你也可以自己编写）名为凿子（chisel）的小脚本增强其功能。单独的凿子可以以脚本指定的各种风格分析sysdig捕获的事件流。

`![](/data/attachment/album/201411/30/212928sfllnunlu88kpueo.png)`

在本教程中，我们将探索sysdig的安装及其基本用法，在Linux上实施系统监控和排障。

### 安装Sysdig

对于本教程，由于为了简便、缩短安装流程以及版本的不可知，我们将选择使用官方网站提供的自动化安装过程。在自动化过程中，安装脚本会自动检测操作系统并安装必需的依赖包。

以root身份运行以下命令来从官方apt/yum仓库安装sysdig：

```shell
# curl -s https://s3.amazonaws.com/download.draios.com/stable/install-sysdig | bash 
```

`![](/data/attachment/album/201411/30/213114hdh8fh9gh1bggfgf.jpg)`

安装完成后，我们可以通过以下方法调用sysdig来感受一下它：

```shell
# sysdig 
```

我们的屏幕将马上被系统上发生的所有事件填满，对于这些信息，不便于我们做更多操作。要进一步处理，我们可以运行：

```shell
# sysdig -cl | less 
```

来查看可用的凿子列表。

`![](/data/attachment/album/201411/30/213117v29uqfeaqjbsp2tk.jpg)`

默认有以下类目可用，各个类目中分布有多个内建的凿子。

* CPU Usage：CPU使用量
* Errors：错误
* I/O
* Logs：日志
* Misc：混杂
* Net：网络
* Performance：性能
* Security：安全
* System State：系统状态

要显示指定凿子上的信息（包括详细的命令行用法），运行以下命令：

```shell
# sysdig -cl [凿子名称] 
```

例如，我们可以检查“网络”类目下关于spy\_port凿子的信息：

```shell
# sysdig -i spy_port 
```

`![](/data/attachment/album/201411/30/213120teec01llsdua0juj.jpg)`

凿子可以通过过滤器（可同时应用于实时数据和记录文件）组合，以获取更多有用的输出。

过滤器遵从“类.字段”结构。例如：

* **fd.cip**：客户端IP地址。
* **evt.dir**：事件方向，可以是‘>’用于进入事件，或‘<’用于退出事件。

完整的过滤器列表可以通过以下命令显示：

```shell
# sysdig -l 
```

在本教程剩余部分，我将演示几个sysdig的使用案例。

### Sysdig实例： 服务器性能排障

假定你的服务器发生了性能问题（如，没有回应，或者重大的回应延迟）。你可以使用瓶颈凿子来显示当前10个最慢系统调用的列表。

使用以下命令在存活服务器上进行实时检查。“-c”标识，后跟凿子名称告诉sysdig运行指定的凿子。

```shell
# sysdig -c bottlenecks 
```

或者，你可以离线对服务器实施性能分析。在此种情况下，你可以保存完整的sysdig记录到文件，然后像下面这样针对记录运行瓶颈凿子。

首先，保存sysdige记录（使用Ctrl+c来停止收集）：

```shell
# sysdig -w trace.scap 
```

收集完记录后，你可以运行以下命令来检查捕获间隔中最慢的系统调用：

```shell
# sysdig -r trace.scap -c bottlenecks 
```

`![](/data/attachment/album/201411/30/213124mrtttsi873rik5wh.jpg)`

你需要关注栏#2，#3和#4，这些分别表示执行时间、进程名和PID。

### Sysdig实例： 监控交互用户活动

假定你作为系统管理员想要监控系统中交互的用户活动（如，用户在命令行输入了什么命令，以及用户去了什么目录），这时spy\_user凿子就派上用场了。

让我们首先通过一些额外选项来收集一个sysdig记录。

```shell
# sysdig -s 4096 -z -w /mnt/sysdig/$(hostname).scap.gz 
```

* “-s 4096”告诉sysdig每个事件捕获4096字节。
* “-z” （与“-w”一起使用）为记录文件启用压缩。
* “-w ”保存sysdig记录到指定的文件。

在上面的例子中，我们自定义了基于每个主机的压缩的记录文件的名称。记住，你可以在任何时候按下Ctrl+c来打断sysdig的执行。

在我们收集到了合理数量的数据后，我们可以通过运行以下命令来查看每个用户的交互活动：

```shell
# sysdig -r /mnt/sysdig/debian.scap.gz -c spy_users 
```

`![](/data/attachment/album/201411/30/213126gu3ix5dk5y5kzuct.jpg)`

上面输出的第一栏表示与指定用户的活动相关进程的PID。

如果你想要定位一个指定的用户，以及只监控该用户的活动又怎么样呢？你可以通过用户名对spy\_users凿子的结果进行过滤：

```shell
# sysdig -r /mnt/sysdig/debian.scap.gz -c spy_users "user.name=xmodulo" 
```

`![](/data/attachment/album/201411/30/213128nb0isikzzpi1jhl2.jpg)`

### Sysdig实例： 监控文件I/O

我们可以使用“-p”标识来自定义sysdig记录的输出格式，并指定双引号括起来的想要的字段（如用户名、进程名，以及文件或套接口名称）。在本例中，我们将创建一个记录文件，该文件将只包含在家目录中的写入事件（我们今后可以使用“sysdig -r writetrace.scap.gz”来检测该文件）。

```shell
# sysdig -p "%user.name %proc.name %fd.name" "evt.type=write and fd.name contains /home/" -z -w writetrace.scap.gz 
```

`![](/data/attachment/album/201411/30/213134kulb8b3eeu3r3zg3.jpg)`

### Sysdig实例： 监控网络I/O

作为服务器排障的一部分，你可能想要监听网络通信，此工作通常由tcpdump做。对于sysdig，可以很容易进行通信嗅探，其风格更为对用户友好。

例如，你可以检查由特定IP地址，特定进程（如apache2）提供的数据（ASCII编码格式）：

```shell
# sysdig -s 4096 -A -c echo_fds fd.cip=192.168.0.100 -r /mnt/sysdig/debian.scap.gz proc.name=apache2 
```

如果你想要监控原生数据传输（二进制格式），请把“-A”替换为“-X”：

```shell
# sysdig -s 4096 -X -c echo_fds fd.cip=192.168.0.100 -r /mnt/sysdig/debian.scap.gz proc.name=apache2 
```

要获取更多信息、实例以及案例分析，你可以查阅[项目网站](http://www.sysdig.org/)。相信我，会有着无限可能，但请不要仅仅局限于我所写的这些。安装sysdig，请从今天开始深入挖掘吧！

---

via: <http://xmodulo.com/monitor-troubleshoot-linux-server-sysdig.html>

作者：[Gabriel Cánepa](http://xmodulo.com/author/gabriel) 译者：[GOLinux](https://github.com/GOLinux) 校对：[wxy](https://github.com/wxy)

本文由 [LCTT](https://github.com/LCTT/TranslateProject) 原创翻译，[Linux中国](https://linux.cn/) 荣誉推出

***

## Comments

|   index | 日期                | 日期                                   | 评论                                                                                                                                                                                      |
|--------:|:--------------------|:---------------------------------------|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|       0 | 2014-11-30 22:03:02 | 微博评论                               | //@lidaobing:转发微博                                                                                                                                                                     |
|       1 | 2014-11-30 22:33:01 | 微博评论                               | @我的印象笔记                                                                                                                                                                             |
|       2 | 2014-11-30 22:33:01 | 微博评论                               | 它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                                               |
|       3 | 2014-11-30 22:33:01 | 微博评论                               | 保存学习//@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                          |
|       4 | 2014-11-30 23:03:03 | 微博评论                               | Repost                                                                                                                                                                                    |
|       5 | 2014-11-30 23:03:03 | 微博评论                               | [太开心] //@-神仙-: //@lidaobing:转发微博                                                                                                                                                 |
|       6 | 2014-11-30 23:03:03 | 微博评论                               | 非常棒的一个工具 //@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                 |
|       7 | 2014-11-30 23:03:03 | 微博评论                               | sysdig//@Linux中国: 它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                           |
|       8 | 2014-11-30 23:03:03 | 微博评论                               | 是个好东西                                                                                                                                                                                |
|       9 | 2014-11-30 23:33:01 | 微博评论                               | @我的印象笔记  //@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                         |
|      10 | 2014-11-30 23:33:01 | 微博评论                               | MA                                                                                                                                                                                        |
|      11 | 2014-12-01 00:03:01 | 微博评论                               | 仅仅是整合了一下子吗                                                                                                                                                                      |
|      12 | 2014-12-01 00:03:01 | 微博评论                               | 嗯  //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                          |
|      13 | 2014-12-01 00:03:01 | 微博评论                               | //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                              |
|      14 | 2014-12-01 00:03:01 | 微博评论                               | @mywiz                                                                                                                                                                                    |
|      15 | 2014-12-01 00:33:03 | 微博评论                               | //@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                                  |
|      16 | 2014-12-01 00:33:03 | 微博评论                               | 看看                                                                                                                                                                                      |
|      17 | 2014-12-01 00:33:03 | 微博评论                               | //@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                                  |
|      18 | 2014-12-01 00:33:03 | 微博评论                               | 这工具很不错，收藏！                                                                                                                                                                      |
|      19 | 2014-12-01 00:33:03 | 微博评论                               | Cool tool //@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                          |
|      20 | 2014-12-01 00:33:03 | 微博评论                               | //@sunbiao将军://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                   |
|      21 | 2014-12-01 00:33:03 | 微博评论                               | 系统工具@我的印象笔记                                                                                                                                                                     |
|      22 | 2014-12-01 00:33:03 | 微博评论                               | //@KissDev:Cool tool //@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                               |
|      23 | 2014-12-01 01:03:00 | 微博评论                               | 马克//@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                              |
|      24 | 2014-12-01 01:03:00 | 微博评论                               | //@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                                  |
|      25 | 2014-12-01 01:03:00 | 微博评论                               | cool //@易到用车王柏://@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                               |
|      26 | 2014-12-01 01:03:00 | 微博评论                               | //@3rddayFPA: //@KissDev:Cool tool //@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                 |
|      27 | 2014-12-01 01:33:01 | 微博评论                               | //@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                                  |
|      28 | 2014-12-01 01:33:01 | 微博评论                               | //@3rddayFPA:  //@KissDev:Cool tool //@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                |
|      29 | 2014-12-01 01:33:01 | 微博评论                               | 收藏 //@fengyuncrawl:这工具很不错，收藏！                                                                                                                                                 |
|      30 | 2014-12-01 03:03:01 | 微博评论                               | 试试//@宋超_去哪儿呢: //@3rddayFPA:  //@KissDev:Cool tool //@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”          |
|      31 | 2014-12-01 03:03:01 | 微博评论                               | 真心高级了：）                                                                                                                                                                            |
|      32 | 2014-12-01 04:03:01 | 微博评论                               | //@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                                  |
|      33 | 2014-12-01 04:03:01 | 微博评论                               | //@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                                  |
|      34 | 2014-12-01 07:03:03 | 微博评论                               | 马一下//@马全一: //@sunbiao将军://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                  |
|      35 | 2014-12-01 07:33:00 | 微博评论                               | //@KissDev:Cool tool //@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                               |
|      36 | 2014-12-01 08:03:01 | 微博评论                               | //@马全一: //@sunbiao将军://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                        |
|      37 | 2014-12-01 08:03:01 | 微博评论                               | 好东西 //@iSunshow://@周明智:收藏 //@fengyuncrawl:这工具很不错，收藏！                                                                                                                    |
|      38 | 2014-12-01 08:03:01 | 微博评论                               | @我的印象笔记                                                                                                                                                                             |
|      39 | 2014-12-01 08:03:01 | 微博评论                               | //@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                                                  |
|      40 | 2014-12-01 08:33:01 | 微博评论                               | //@fengyuncrawl:这工具很不错，收藏！                                                                                                                                                      |
|      41 | 2014-12-01 08:33:01 | 微博评论                               | mark //@fengyuncrawl:这工具很不错，收藏！                                                                                                                                                 |
|      42 | 2014-12-01 09:03:01 | 微博评论                               | @我的印象笔记                                                                                                                                                                             |
|      43 | 2014-12-01 09:03:01 | 微博评论                               | //@来炜没睡醒:真心高级了：）                                                                                                                                                              |
|      44 | 2014-12-01 09:03:01 | 微博评论                               | //@马全一: //@sunbiao将军://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                                                                        |
|      45 | 2014-12-01 09:03:01 | 微博评论                               | //@-神仙-: //@lidaobing:转发微博                                                                                                                                                          |
|      46 | 2014-12-01 09:33:01 | 微博评论                               | @Linuxyunwei                                                                                                                                                                              |
|      47 | 2014-12-01 09:33:01 | 微博评论                               | //@ASTA谢: //@-神仙-: //@lidaobing:转发微博                                                                                                                                               |
|      48 | 2014-12-01 09:33:01 | 微博评论                               | 收藏                                                                                                                                                                                      |
|      49 | 2014-12-01 09:43:21 | 来自 - 广东广州 的 Chrome/Windows 用户 | @我的印象笔记                                                                                                                                                                             |
|      50 | 2014-12-01 10:03:03 | 微博评论                               | @我的印象笔记                                                                                                                                                                             |
|      51 | 2014-12-01 10:03:03 | 微博评论                               | //@ASTA谢: //@-神仙-: //@lidaobing:转发微博                                                                                                                                               |
|      52 | 2014-12-01 10:03:03 | 微博评论                               | @我的印象笔记 //@n4mine: //@ASTA谢: //@-神仙-: //@lidaobing:转发微博                                                                                                                      |
|      53 | 2014-12-01 10:33:04 | 微博评论                               | //@ASTA谢: //@-神仙-: //@lidaobing:转发微博                                                                                                                                               |
|      54 | 2014-12-01 12:03:01 | 微博评论                               | @我的印象笔记                                                                                                                                                                             |
|      55 | 2014-12-01 17:33:01 | 微博评论                               | 回头研究一下                                                                                                                                                                              |
|      56 | 2014-12-01 18:33:01 | 微博评论                               | @热情萧远山 @kykij @cjfeii  //@KissDev:Cool tool //@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁”                   |
|      57 | 2014-12-01 19:03:04 | 微博评论                               | mark//@ruochen_SH: @热情萧远山 @kykij @cjfeii //@KissDev:Cool tool //@mylua: //@王关胜://@归文胜://@Linux中国:它的创建者在介绍它时称之为“strace+tcpdump+lsof+上面点缀着lua樱桃的绝妙酱汁” |
|      58 | 2014-12-01 21:33:03 | 微博评论                               | //@-浩泓-:转发微博                                                                                                                                                                        |
|      59 | 2014-12-01 21:33:03 | 微博评论                               | @我的印象笔记                                                                                                                                                                             |
|      60 | 2014-12-02 00:03:09 | 微博评论                               | m//@n4mine: //@ASTA谢: //@-神仙-: //@lidaobing:转发微博                                                                                                                                   |
|      61 | 2014-12-02 00:03:09 | 微博评论                               | @我的印象笔记                                                                                                                                                                             |
|      62 | 2014-12-02 07:33:04 | 微博评论                               | @我的印象笔记 //@团团爱荛六://@lidaobing：转发微博                                                                                                                                        |
|      63 | 2014-12-02 10:33:03 | 微博评论                               | @我的印象笔记                                                                                                                                                                             |
|      64 | 2014-12-02 20:58:50 | mine                                   | 不错不错                                                                                                                                                                                  |
|      65 | 2014-12-06 11:33:02 | 微博评论                               | @胶布虫 @___枫恋寒                                                                                                                                                                        |
|      66 | 2015-05-17 13:18:21 | chuyi                                  | 学习了                                                                                                                                                                                    |
